<!-- src/views/EventDetails.vue -->
<template>
    <div class="event-nav-container">
        <div v-if="loadingEvent || loadingFavoriteDate">Chargement des données...</div>
        <div v-else-if="error">{{ error }}</div>
        <div v-else>
          <EventSummary :event="event.event" :view="event.view" :favoriteDate="favoriteDate"/>
          <nav class="event-tabs">

            <router-link :to="{ name: 'EventInfo' }" class="tab" active-class="active">
              <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14.1562 19.7266H9.84375C5.94094 19.7266 4.27344 18.0591 4.27344 14.1562V9.84375C4.27344 5.94094 5.94094 4.27344 9.84375 4.27344H14.1562C18.0591 4.27344 19.7266 5.94094 19.7266 9.84375V14.1562C19.7266 18.0591 18.0591 19.7266 14.1562 19.7266ZM9.84375 5.35156C6.53031 5.35156 5.35156 6.53031 5.35156 9.84375V14.1562C5.35156 17.4697 6.53031 18.6484 9.84375 18.6484H14.1562C17.4697 18.6484 18.6484 17.4697 18.6484 14.1562V9.84375C18.6484 6.53031 17.4697 5.35156 14.1562 5.35156H9.84375Z" fill="currentColor"/>
                <path d="M9.61375 14.3934C9.31188 14.3934 9.03156 14.3216 8.78719 14.185C8.19063 13.8472 7.86719 13.1788 7.86719 12.3019V5.12875C7.86719 4.83407 8.11156 4.58969 8.40625 4.58969C8.70094 4.58969 8.94531 4.83407 8.94531 5.12875V12.3019C8.94531 12.7691 9.08188 13.1141 9.31906 13.2434C9.57063 13.3872 9.95875 13.3153 10.3828 13.0638L11.3316 12.4959C11.7197 12.2659 12.2731 12.2659 12.6613 12.4959L13.61 13.0638C14.0412 13.3225 14.4294 13.3872 14.6738 13.2434C14.9109 13.1069 15.0475 12.7619 15.0475 12.3019V5.12875C15.0475 4.83407 15.2919 4.58969 15.5866 4.58969C15.8812 4.58969 16.1256 4.83407 16.1256 5.12875V12.3019C16.1256 13.1788 15.8022 13.8472 15.2056 14.185C14.6091 14.5228 13.8256 14.4509 13.0566 13.9909L12.1078 13.4231C12.0647 13.3944 11.9281 13.3944 11.885 13.4231L10.9363 13.9909C10.4906 14.2569 10.0306 14.3934 9.61375 14.3934Z" fill="currentColor"/>
                <path d="M14.1562 19.7266H9.84375C5.94094 19.7266 4.27344 18.0591 4.27344 14.1562V9.84375C4.27344 5.94094 5.94094 4.27344 9.84375 4.27344H14.1562C18.0591 4.27344 19.7266 5.94094 19.7266 9.84375V14.1562C19.7266 18.0591 18.0591 19.7266 14.1562 19.7266ZM9.84375 5.35156C6.53031 5.35156 5.35156 6.53031 5.35156 9.84375V14.1562C5.35156 17.4697 6.53031 18.6484 9.84375 18.6484H14.1562C17.4697 18.6484 18.6484 17.4697 18.6484 14.1562V9.84375C18.6484 6.53031 17.4697 5.35156 14.1562 5.35156H9.84375Z" fill="currentColor"/>
                <path d="M9.61375 14.3934C9.31188 14.3934 9.03156 14.3216 8.78719 14.185C8.19063 13.8472 7.86719 13.1788 7.86719 12.3019V5.12875C7.86719 4.83407 8.11156 4.58969 8.40625 4.58969C8.70094 4.58969 8.94531 4.83407 8.94531 5.12875V12.3019C8.94531 12.7691 9.08188 13.1141 9.31906 13.2434C9.57063 13.3872 9.95875 13.3153 10.3828 13.0638L11.3316 12.4959C11.7197 12.2659 12.2731 12.2659 12.6613 12.4959L13.61 13.0638C14.0412 13.3225 14.4294 13.3872 14.6738 13.2434C14.9109 13.1069 15.0475 12.7619 15.0475 12.3019V5.12875C15.0475 4.83407 15.2919 4.58969 15.5866 4.58969C15.8812 4.58969 16.1256 4.83407 16.1256 5.12875V12.3019C16.1256 13.1788 15.8022 13.8472 15.2056 14.185C14.6091 14.5228 13.8256 14.4509 13.0566 13.9909L12.1078 13.4231C12.0647 13.3944 11.9281 13.3944 11.885 13.4231L10.9363 13.9909C10.4906 14.2569 10.0306 14.3934 9.61375 14.3934Z" fill="currentColor"/>
              </svg>
              <p>Infos</p>
            </router-link>

            <router-link :to="{ name: 'EventParticipants'}" class="tab" active-class="active">
              <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16.4373 8.97512C16.4152 8.97512 16.4004 8.97512 16.3782 8.97512H16.3412C14.9434 8.93075 13.9006 7.85095 13.9006 6.5197C13.9006 5.15887 15.01 4.05688 16.3634 4.05688C17.7168 4.05688 18.8262 5.16626 18.8262 6.5197C18.8188 7.85834 17.776 8.93814 16.4447 8.98251C16.4447 8.97512 16.4447 8.97512 16.4373 8.97512ZM16.3634 5.15887C15.6164 5.15887 15.0099 5.76533 15.0099 6.51231C15.0099 7.24449 15.5794 7.83616 16.3116 7.86575C16.319 7.85835 16.3782 7.85835 16.4447 7.86575C17.1621 7.82877 17.7168 7.2371 17.7242 6.51231C17.7242 5.76533 17.1178 5.15887 16.3634 5.15887Z" fill="currentColor"/>
                <path d="M16.4449 14.4259C16.1565 14.4259 15.868 14.4037 15.5796 14.3519C15.2764 14.3001 15.0767 14.0117 15.1284 13.7085C15.1802 13.4052 15.4686 13.2055 15.7719 13.2573C16.6816 13.4126 17.643 13.2425 18.2865 12.8136C18.6341 12.5843 18.819 12.2959 18.819 12.0074C18.819 11.719 18.6267 11.4379 18.2865 11.2087C17.643 10.7797 16.6668 10.6096 15.7497 10.7723C15.4465 10.8315 15.158 10.6244 15.1062 10.3212C15.0545 10.0179 15.2542 9.7295 15.5574 9.67773C16.7629 9.46325 18.0128 9.69252 18.9003 10.2842C19.5511 10.7205 19.9283 11.3418 19.9283 12.0074C19.9283 12.6656 19.5585 13.2943 18.9003 13.738C18.2273 14.1818 17.3546 14.4259 16.4449 14.4259Z" fill="currentColor"/>
                <path d="M7.54029 8.9751C7.5329 8.9751 7.5255 8.9751 7.5255 8.9751C6.19425 8.93073 5.15144 7.85093 5.14404 6.51968C5.14404 5.15885 6.25342 4.04948 7.60686 4.04948C8.96029 4.04948 10.0697 5.15885 10.0697 6.51229C10.0697 7.85094 9.02686 8.93073 7.69561 8.9751L7.54029 8.42042L7.59206 8.9751C7.57727 8.9751 7.55509 8.9751 7.54029 8.9751ZM7.61425 7.86573C7.65863 7.86573 7.69561 7.86573 7.73998 7.87312C8.39821 7.84354 8.97508 7.25187 8.97508 6.51968C8.97508 5.7727 8.36863 5.16624 7.62165 5.16624C6.87467 5.16624 6.26821 5.7727 6.26821 6.51968C6.26821 7.24447 6.83029 7.82875 7.54769 7.87312C7.55508 7.86573 7.58467 7.86573 7.61425 7.86573Z" fill="currentColor"/>
                <path d="M7.53294 14.4259C6.62325 14.4259 5.75054 14.1818 5.07752 13.738C4.42669 13.3017 4.0495 12.673 4.0495 12.0074C4.0495 11.3492 4.42669 10.7205 5.07752 10.2842C5.96502 9.69252 7.21492 9.46325 8.42044 9.67773C8.72367 9.7295 8.92335 10.0179 8.87158 10.3212C8.81981 10.6244 8.53138 10.8315 8.22815 10.7723C7.31106 10.6096 6.34221 10.7797 5.69138 11.2087C5.34377 11.4379 5.15887 11.719 5.15887 12.0074C5.15887 12.2959 5.35117 12.5843 5.69138 12.8136C6.33481 13.2425 7.29627 13.4126 8.20596 13.2573C8.50919 13.2055 8.79763 13.4126 8.8494 13.7085C8.90117 14.0117 8.70148 14.3001 8.39825 14.3519C8.10981 14.4037 7.82137 14.4259 7.53294 14.4259Z" fill="currentColor"/>
                <path d="M11.9998 14.4998C11.9777 14.4998 11.9629 14.4998 11.9407 14.4998H11.9037C10.5059 14.4554 9.46307 13.3756 9.46307 12.0444C9.46307 10.6835 10.5725 9.58155 11.9259 9.58155C13.2793 9.58155 14.3887 10.6909 14.3887 12.0444C14.3813 13.383 13.3385 14.4628 12.0072 14.5072C12.0072 14.4998 12.0072 14.4998 11.9998 14.4998ZM11.9259 10.6835C11.1789 10.6835 10.5724 11.29 10.5724 12.037C10.5724 12.7692 11.1419 13.3608 11.8741 13.3904C11.8815 13.383 11.9407 13.383 12.0072 13.3904C12.7246 13.3534 13.2793 12.7618 13.2867 12.037C13.2867 11.2974 12.6803 10.6835 11.9259 10.6835Z" fill="currentColor"/>
                <path d="M11.9999 19.9579C11.1124 19.9579 10.2249 19.7286 9.53705 19.2627C8.88622 18.8263 8.50903 18.2051 8.50903 17.5395C8.50903 16.8812 8.87882 16.2452 9.53705 15.8088C10.9201 14.8917 13.0871 14.8917 14.4627 15.8088C15.1135 16.2452 15.4907 16.8664 15.4907 17.5321C15.4907 18.1903 15.1209 18.8263 14.4627 19.2627C13.7749 19.7212 12.8874 19.9579 11.9999 19.9579ZM10.1509 16.7407C9.8033 16.97 9.61841 17.2584 9.61841 17.5469C9.61841 17.8353 9.8107 18.1163 10.1509 18.3456C11.1493 19.0186 12.843 19.0186 13.8414 18.3456C14.189 18.1163 14.3739 17.8279 14.3739 17.5395C14.3739 17.251 14.1816 16.97 13.8414 16.7407C12.8504 16.0677 11.1567 16.0751 10.1509 16.7407Z" fill="currentColor"/>
              </svg>
              <p>Participants</p>
            </router-link>

            <router-link :to="{ name: 'EventListPost' }" class="tab" active-class="active">
              <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 19.8823C11.4969 19.8823 11.0229 19.6271 10.6875 19.1823L9.59376 17.724C9.57188 17.6948 9.48439 17.6583 9.44793 17.651H9.08334C6.04272 17.651 4.16147 16.8271 4.16147 12.7292V9.08334C4.16147 5.86042 5.86043 4.16146 9.08334 4.16146H14.9167C18.1396 4.16146 19.8386 5.86042 19.8386 9.08334V12.7292C19.8386 15.9521 18.1396 17.651 14.9167 17.651H14.5521C14.4938 17.651 14.4427 17.6802 14.4063 17.724L13.3125 19.1823C12.9771 19.6271 12.5031 19.8823 12 19.8823ZM9.08334 5.25521C6.47293 5.25521 5.25522 6.47292 5.25522 9.08334V12.7292C5.25522 16.025 6.38543 16.5573 9.08334 16.5573H9.44793C9.8198 16.5573 10.2427 16.7688 10.4688 17.0677L11.5625 18.526C11.8177 18.8615 12.1823 18.8615 12.4375 18.526L13.5313 17.0677C13.7719 16.7469 14.1511 16.5573 14.5521 16.5573H14.9167C17.5271 16.5573 18.7448 15.3396 18.7448 12.7292V9.08334C18.7448 6.47292 17.5271 5.25521 14.9167 5.25521H9.08334Z" fill="currentColor"/>
                <path d="M15.6459 9.63021H8.35422C8.05526 9.63021 7.80734 9.38229 7.80734 9.08334C7.80734 8.78438 8.05526 8.53646 8.35422 8.53646H15.6459C15.9448 8.53646 16.1928 8.78438 16.1928 9.08334C16.1928 9.38229 15.9448 9.63021 15.6459 9.63021Z" fill="currentColor"/>
                <path d="M12.7292 13.276H8.35422C8.05526 13.276 7.80734 13.0281 7.80734 12.7292C7.80734 12.4302 8.05526 12.1823 8.35422 12.1823H12.7292C13.0282 12.1823 13.2761 12.4302 13.2761 12.7292C13.2761 13.0281 13.0282 13.276 12.7292 13.276Z" fill="currentColor"/>
              </svg>
              <p>Messages</p>
            </router-link>

            <router-link :to="{ name: 'EventKercount' }" class="tab" active-class="active">
              <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.8864 19.2786H8.11352C6.42758 19.2786 5.05988 17.9109 5.05988 16.225V11.6682C5.05988 9.9823 6.42758 8.61459 8.11352 8.61459H15.8864C17.5724 8.61459 18.9401 9.9823 18.9401 11.6682V12.6432C18.9401 12.9208 18.7099 13.1511 18.4323 13.1511H17.0646C16.8276 13.1511 16.6109 13.2391 16.4552 13.4016L16.4484 13.4083C16.2588 13.5912 16.1708 13.8417 16.1911 14.0989C16.2318 14.5458 16.6583 14.9047 17.1458 14.9047H18.4323C18.7099 14.9047 18.9401 15.1349 18.9401 15.4125V16.2182C18.9401 17.9109 17.5724 19.2786 15.8864 19.2786ZM8.11352 9.63021C6.98956 9.63021 6.0755 10.5443 6.0755 11.6682V16.225C6.0755 17.349 6.98956 18.263 8.11352 18.263H15.8864C17.0104 18.263 17.9245 17.349 17.9245 16.225V15.9271H17.1458C16.1234 15.9271 15.2568 15.1687 15.1755 14.1937C15.1213 13.6385 15.3245 13.0901 15.7307 12.6906C16.0828 12.3318 16.5568 12.1354 17.0646 12.1354H17.9245V11.6682C17.9245 10.5443 17.0104 9.63021 15.8864 9.63021H8.11352Z" fill="currentColor"/>
                <path d="M5.56769 12.7854C5.29008 12.7854 5.05988 12.5552 5.05988 12.2776V9.18337C5.05988 8.17452 5.69633 7.26042 6.63748 6.90156L12.0135 4.87031C12.5687 4.66042 13.1849 4.73493 13.6656 5.07347C14.1531 5.41201 14.4375 5.96045 14.4375 6.54951V9.12242C14.4375 9.40002 14.2073 9.63023 13.9297 9.63023C13.6521 9.63023 13.4219 9.40002 13.4219 9.12242V6.54951C13.4219 6.29222 13.3 6.05523 13.0833 5.90627C12.8666 5.75731 12.6094 5.72345 12.3656 5.81825L6.98956 7.8495C6.44113 8.05939 6.06873 8.59431 6.06873 9.18337V12.2776C6.0755 12.562 5.84529 12.7854 5.56769 12.7854Z" fill="currentColor"/>
                <path d="M17.1458 15.927C16.1234 15.927 15.2567 15.1687 15.1755 14.1937C15.1213 13.6317 15.3244 13.0833 15.7307 12.6838C16.076 12.3317 16.55 12.1354 17.0578 12.1354H18.4661C19.1364 12.1557 19.651 12.6838 19.651 13.3338V14.7286C19.651 15.3786 19.1364 15.9067 18.4864 15.927H17.1458ZM18.4526 13.151H17.0645C16.8276 13.151 16.6109 13.239 16.4552 13.4015C16.2588 13.5911 16.164 13.8484 16.1911 14.1057C16.2317 14.5526 16.6583 14.9114 17.1458 14.9114H18.4729C18.5609 14.9114 18.6422 14.8302 18.6422 14.7286V13.3338C18.6422 13.2322 18.5609 13.1578 18.4526 13.151Z" fill="currentColor"/>
                <path d="M13.3541 12.5078H8.61456C8.33696 12.5078 8.10675 12.2776 8.10675 12C8.10675 11.7224 8.33696 11.4922 8.61456 11.4922H13.3541C13.6318 11.4922 13.862 11.7224 13.862 12C13.862 12.2776 13.6318 12.5078 13.3541 12.5078Z" fill="#A8ACB7"/>
              </svg>
              <p>Kercount</p>
            </router-link>

          </nav>
          <router-view :event="event"></router-view>
        </div>
    </div>
  </template>
  
  <script setup >
    import { ref, onMounted } from 'vue';
    import { useRoute, useRouter } from 'vue-router';
    import { useUserStore } from '../stores/userStore';
    import EventSummary from './EventSummary.vue';

    const route = useRoute();
    const router = useRouter();
    const event = ref({});
    const userStore = useUserStore();
    
    const loadingEvent = ref(true);
    const loadingFavoriteDate = ref(true);
    const error = ref(null);
    const favoriteDate = ref({});
    const API_URL = import.meta.env.DEV  
    ? `${window.location.protocol}//${window.location.hostname}:3000`
    : import.meta.env.VITE_API_URL;
    
          
  
    const fetchEventDetails = async () => {
        
      try {
        let apiUrl = `${API_URL}/api/events/${route.params.id}/infoEvent`;

        // Vérifiez si l'utilisateur a créé cet événement
        const isEventCreatedByUser = userStore.eventsCreated.some(event => String(event.id) === String(route.params.id));
        

        // Si l'utilisateur a créé cet événement, ajoutez le token à l'URL
        if (isEventCreatedByUser) {
          apiUrl += `/${userStore.token}`;
        }
        
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error('Erreur HTTP');
        }
        event.value = await response.json();
        
      } catch (err) {
        error.value = 'Erreur lors de la récupération des détails de l\'événement.';
        console.error(err);
      } finally {
        loadingEvent.value = false;
      }
    };

    const fetchDateFavorite = async () => {
      try {
        let apiUrl = `${API_URL}/api/events/${route.params.id}/favoriteDate`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error('Erreur HTTP');
        }
        favoriteDate.value = await response.json();
        favoriteDate.value.eventDate.forEach(element => {
          const date = new Date(element.proposed_date);
          element.proposed_date = new Intl.DateTimeFormat("fr-FR", {
            day: "2-digit",
            month: "long",
            year: "numeric",
          }).format(date);        
        });
        
        
      } catch (err) {
        error.value = 'Erreur lors de la récupération des détails de l\'événement.';
        console.error(err);
      } finally {
        loadingFavoriteDate.value = false;
      }
    };
  
    onMounted(() => {
      fetchEventDetails();
      fetchDateFavorite();
      if (!userStore.email) {
        router.push('/404');
      }      
    });

  </script>
  
  <style scoped>

  .event-tabs {
    position: fixed;
    bottom: 10px;
    width: 96dvw;
    display: flex;
    justify-content: space-evenly;
    left: 50%;
    transform: translateX(-50%);
    height: 50px;
    border-radius: 4px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(28px);
    overflow: hidden;
    z-index: 1;
  }

  .tab {
    text-decoration: none;
    color: #FFFFFF;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .tab > p {
    font-size: 12px;
    font-family: 'General sans';
    font-weight: 500;
    margin: 0;
    transform: translateY(60px);
    position: absolute;
    transition: transform 0.3s ease;
  }

  .tab .icon {
    width: 42px;
    height: 42px;
    color: #A8ACB7;
    transition: transform 0.3s ease, color 0.3s ease;
  }

  .tab.active .icon {
    color: #FFFFFF;
    transform: translateY(-7px) scale(0.75);
  }

  .tab.active p {
    transform: translateY(15px);
  }
  </style>
  